#!/usr/bin/env bash

# Synopsis:
# Test the track's exercises.
#
# At a minimum, this file must check if the example/exemplar solution of each
# Practice/Concept Exercise passes the exercise's tests.
#
# To check this, you usually have to (temporarily) replace the exercise's solution files
# with its exemplar/example files.
#
# If your track uses skipped tests, make sure to (temporarily) enable these tests
# before running the tests.
#
# The path to the solution/example/exemplar files can be found in the exercise's
# .meta/config.json file, or possibly inferred from the exercise's directory name.

die () { echo "$*" >&2; exit 1; }

top_dir="$(realpath "$(dirname "$0")/..")"
cd "$top_dir" || die "Can't cd to $top_dir"
shopt -s nullglob
failures=()

for exercise_dir in exercises/{concept,practice}/*/; do
    if [[ -d $exercise_dir ]]; then
        bin/check-exercise.sh "${exercise_dir}" || failures+=( "$(basename "${exercise_dir}")" )
        echo ""
    fi
done

rm tmp.*
if (( ${#failures[@]} > 0 )); then
    {
        echo '==========================='
        echo '[ERROR] exercises failures!'
        for f in "${failures[@]}"; do printf -- '- %s\n' "$f"; done
    } >&2
    exit 1
fi

exit 0
